name: Deploy Python Script to GCP

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Create env-vars.yaml from GitHub secrets
        run: |
          echo "GCP_SA_KEY: '${{ secrets.GCP_SA_KEY }}'" > env-vars.yaml
          echo "MONGODB_URI: '${{ secrets.MONGODB_URI }}'" >> env-vars.yaml
          echo "MONGODB_DB_NAME: '${{ secrets.MONGODB_DB_NAME }}'" >> env-vars.yaml
          echo "MONGODB_ITINERARIES_COLLECTION_NAME: '${{ secrets.MONGODB_ITINERARIES_COLLECTION_NAME }}'" >> env-vars.yaml
          echo "MONGODB_ITINERARIES_COLLECTION_THRESHOLD: '${{ secrets.MONGODB_ITINERARIES_COLLECTION_THRESHOLD }}'" >> env-vars.yaml
          echo "MONGODB_TRIPS_COLLECTION_NAME: '${{ secrets.MONGODB_TRIPS_COLLECTION_NAME }}'" >> env-vars.yaml
          echo "MONGODB_TRIPS_COLLECTION_THRESHOLD: '${{ secrets.MONGODB_TRIPS_COLLECTION_THRESHOLD }}'" >> env-vars.yaml
          echo "MONGODB_DELETE_PCT: '${{ secrets.MONGODB_DELETE_PCT }}'" >> env-vars.yaml
          echo "REDIS_HOST: '${{ secrets.REDIS_HOST }}'" >> env-vars.yaml
          echo "REDIS_PORT: '${{ secrets.REDIS_PORT }}'" >> env-vars.yaml
          echo "REDIS_USERNAME: '${{ secrets.REDIS_USERNAME }}'" >> env-vars.yaml
          echo "REDIS_PASSWORD: '${{ secrets.REDIS_PASSWORD }}'" >> env-vars.yaml
          echo "REDIS_KEYS_THRESHOLD: '${{ secrets.REDIS_KEYS_THRESHOLD }}'" >> env-vars.yaml
          echo "REDIS_DELETE_PCT: '${{ secrets.REDIS_DELETE_PCT }}'" >> env-vars.yaml
          echo "GCP_SCHEDULER_SA_EMAIL: '${{ secrets.GCP_SCHEDULER_SA_EMAIL }}'" >> env-vars.yaml
          echo "GCP_FUNCTION_URL: '${{ secrets.GCP_FUNCTION_URL }}'" >> env-vars.yaml

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Deploy to GCP (Cloud Function)
        run: |
          gcloud config set project travel-bureau
          gcloud functions deploy travel-bureau-db-optimizer \
            --runtime python311 \
            --trigger-http \
            --source . \
            --entry-point trigger \
            --env-vars-file env-vars.yaml

      - name: Create Cloud Scheduler job (if not exists)
        run: |
          gcloud config set project travel-bureau

          JOB_NAME="travel-bureau-db-optimizer"
          REGION="us-central1"
          SCHEDULE="0 0 * * */6"  # â° At 00:00 on every 6th day-of-week.
          FUNCTION_URL=${{ secrets.GCP_FUNCTION_URL }}

          # Check if job exists
          if ! gcloud scheduler jobs describe $JOB_NAME --location=$REGION > /dev/null 2>&1; then
            echo "ðŸ“… Creating Cloud Scheduler job: $JOB_NAME"
            gcloud scheduler jobs create http $JOB_NAME \
              --location=$REGION \
              --schedule="$SCHEDULE" \
              --uri="$FUNCTION_URL" \
              --http-method=POST \
              --time-zone="Asia/Kolkata" \
              --oidc-service-account-email="${{ secrets.GCP_SCHEDULER_SA_EMAIL }}" \
              --oidc-token-audience="$FUNCTION_URL"
          else
            echo "âœ… Cloud Scheduler job already exists: $JOB_NAME"
          fi